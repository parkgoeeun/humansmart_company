"use strict";function ChangeDivScroll(){document.getElementById("chatLog");document.getElementById("chatLog").scrollTop=document.getElementById("chatLog").scrollHeight}function convert12H(e,t){var s=t&&t.ampmLabel||["오전","오후"],n=/^([0-9]{2}):([0-9]{2})$/,i=e.match(n);if("undefined"==typeof n)return null;var o=parseInt(i[1]),a=parseInt(i[2]),c=("0"+(12==o?12:o%12)).slice(-2);return s[parseInt(o/12)]+" "+c+":"+a}function savingMemo(){var e=new Date,t=e.getHours();1==(""+t).length&&(t="0"+t);var s=e.getMinutes();1==(""+s).length&&(s="0"+s);if("기타"==$("#info_job").val())var n=$("#info_job_etc").val();else var n=$("#info_job").val();var i={type:"memo",sex:$("#info_sex").val(),age:$("#info_age").val(),job:n,counselingExp:$("#info_abroad").val(),hospitalExp:$("#info_hospital").val(),client:$("#info_client").val(),is_ajax:1};$.ajax({type:"POST",url:"manage_.php",data:i,success:function(){var e=convert12H(""+t+":"+s);document.getElementById("save_status1").innerHTML="자동 저장 완료 ("+e+")"}})}function savingCounseling(){var e=new Date,t=e.getHours();1==(""+t).length&&(t="0"+t);var s=e.getMinutes();1==(""+s).length&&(s="0"+s);var n={type:"diary",no:$("#no").val(),counseling:$("#counseling").val(),is_ajax:1};$.ajax({type:"POST",url:"manage_.php",data:n,success:function(){var e=convert12H(""+t+":"+s);document.getElementById("save_status2").innerHTML="자동 저장 완료 ("+e+")"}})}function menuInit(){$(counselingMenu1).attr("src","/assets/img/of_texttime/menuClient.png"),$(counselingMenu2).attr("src","/assets/img/of_texttime/menuHistory.png"),$(counselingMenu3).attr("src","/assets/img/of_texttime/menuMemo.png"),$(counselingMenu4).attr("src","/assets/img/of_texttime/menuList.png"),$(counselingMenu5).attr("src","/assets/img/of_texttime/menuFaq.png"),$(counselingMenu6).attr("src","/assets/img/of_texttime/menuInfo.png"),$(counselingMenu7).attr("src","/assets/img/of_texttime/menuReservation.png")}function retImoji(e){return e=e.split("[감동]").join('<img src="/assets/img/of_emotion/emotion1_.png" class="imoji_sm">'),e=e.split("[화남]").join('<img src="/assets/img/of_emotion/emotion2_.png" class="imoji_sm">'),e=e.split("[공포]").join('<img src="/assets/img/of_emotion/emotion4_.png" class="imoji_sm">'),e=e.split("[고마움]").join('<img src="/assets/img/of_emotion/emotion3_.png" class="imoji_sm">'),e=e.split("[궁금]").join('<img src="/assets/img/of_emotion/emotion5_.png" class="imoji_sm">'),e=e.split("[기쁨]").join('<img src="/assets/img/of_emotion/emotion6_.png" class="imoji_sm">'),e=e.split("[놀람]").join('<img src="/assets/img/of_emotion/emotion7_.png" class="imoji_sm">'),e=e.split("[슬픔]").join('<img src="/assets/img/of_emotion/emotion8_.png" class="imoji_sm">'),e=e.split("[사랑]").join('<img src="/assets/img/of_emotion/emotion9_.png" class="imoji_sm">'),e=e.split("[눈물]").join('<img src="/assets/img/of_emotion/emotion10_.png" class="imoji_sm">'),e=e.split("[안녕]").join('<img src="/assets/img/of_emotion/emotion11_.png" class="imoji_sm">'),e=e.split("[잘자]").join('<img src="/assets/img/of_emotion/emotion12_.png" class="imoji_sm">'),e=e.split("[최고]").join('<img src="/assets/img/of_emotion/emotion13_.png" class="imoji_sm">'),e=e.split("[쿨쿨]").join('<img src="/assets/img/of_emotion/emotion14_.png" class="imoji_sm">')}function emotion_tab_hide(){$("#emotion_box").fadeOut(),$("#emotion_tab").prop("src","/assets/img/of_emotion/emotion_off.png")}function strip_tags(e,t){var t=(((t||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join(""),s=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,n=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return e.replace(n,"").replace(s,function(e,s){return t.indexOf("<"+s.toLowerCase()+">")>-1?e:""})}window.onload=function(){setTimeout("ChangeDivScroll()",1e3)},document.getElementById("profileMemo").addEventListener("blur",savingMemo,!0),document.getElementById("counselingMemo").addEventListener("blur",savingCounseling,!0);var counselingMenu1="#counseling_menu_1",counselingMenu2="#counseling_menu_2",counselingMenu3="#counseling_menu_3",counselingMenu4="#counseling_menu_4",counselingMenu5="#counseling_menu_5",counselingMenu6="#counseling_menu_6",counselingMenu7="#counseling_menu_7";if($(counselingMenu1).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuClient_.png"),$("#mypage_page1").css("display","block"),$("#mypage_page5, #mypage_page2, #mypage_page4, #mypage_page3, #mypage_page6, #mypage_page7").css("display","none")}),$(counselingMenu2).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuHistory_.png"),$("#mypage_page2").css("display","block"),$("#mypage_page5, #mypage_page1, #mypage_page4, #mypage_page3, #mypage_page6, #mypage_page7").css("display","none")}),$(counselingMenu3).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuMemo_.png"),$("#mypage_page3").css("display","block"),$("#mypage_page5, #mypage_page1, #mypage_page4, #mypage_page2, #mypage_page6, #mypage_page7").css("display","none")}),$(counselingMenu4).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuList_.png"),$("#mypage_page4").css("display","block"),$("#mypage_page5, #mypage_page1, #mypage_page3, #mypage_page2, #mypage_page6, #mypage_page7").css("display","none")}),$(counselingMenu5).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuFaq_.png"),$("#mypage_page5").css("display","block"),$("#mypage_page2, #mypage_page1, #mypage_page4, #mypage_page3, #mypage_page6, #mypage_page7").css("display","none")}),$(counselingMenu6).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuInfo_.png"),$("#mypage_page6").css("display","block"),$("#mypage_page2, #mypage_page1, #mypage_page4, #mypage_page3, #mypage_page5, #mypage_page7").css("display","none")}),$(counselingMenu7).click(function(){menuInit(),$(this).attr("src","/assets/img/of_texttime/menuReservation_.png"),$("#mypage_page7").css("display","block"),$("#mypage_page2, #mypage_page1, #mypage_page4, #mypage_page3, #mypage_page5, #mypage_page6").css("display","none")}),$("#mypage_form").change(function(){var e=$(this).val();"inform_b"==e?(document.getElementById("problem").style.display="none",document.getElementById("inform").style.display="block",document.getElementById("counseling").style.display="none"):"problem_b"==e?(document.getElementById("problem").style.display="block",document.getElementById("inform").style.display="none",document.getElementById("counseling").style.display="none"):"counseling_b"==e&&(document.getElementById("problem").style.display="none",document.getElementById("inform").style.display="none",document.getElementById("counseling").style.display="block")}),$(document).ready(function(){$(counselingMenu1).click();var e=$("#counseling_profile").width()+.5+"px";$("#counseling_menu").css("left",e),$("#messageSendBox").change(function(){$("#messageSendBox").css("height","12%")}),$("#emotion_tab").click(function(){"none"===$("#emotion_box").css("display")?($("#emotion_box").fadeIn(),$("#emotion_tab").prop("src","/assets/img/of_emotion/emotion_on.png")):($("#emotion_box").fadeOut(),$("#emotion_tab").prop("src","/assets/img/of_emotion/emotion_off.png"))}),$(".emotion").click(function(){var e=$(this).prop("id");$("#messageSendBox").html($("#messageSendBox").html()+"<img src='/assets/img/of_emotion/"+e+".png' style='height:20px;vertical-align:bottom;'/>")}),$("#emotion_box").css("bottom",$("#messageSendBox").height()+15),$("#emotion_box").css("left",$("#emotion_tab").offset().left-243),$("#messageSendBox").keyup(function(){$("#emotion_box").css("bottom",$("#messageSendBox").height()+15)}),"기타"==$("#info_job").val()?$("#info_job_etc").css("display","block"):$("#info_job_etc").css("display","none"),$("#info_job").change(function(){"기타"==$("#info_job").val()?$("#info_job_etc").css("display","block"):$("#info_job_etc").css("display","none")})}),$(window).on("resize",function(){var e=$("#counseling_profile").width()+.5+"px";$("#counseling_menu").css("left",e)}),"trost.co.kr"===location.host||"www.trost.co.kr"===location.host)var socket=io.connect("https://trost.co.kr:8763");else if("localhost:8888"===location.host||"www.localhost:8888"===location.host)var socket=io.connect("http://localhost:8763");else var socket=io.connect("http://"+location.host+":8763");var counselingEl=$("#counseling_chat_");socket.on("connect",function(){$(".loader").css("display","block"),$(".opacityBg").css("display","block"),socket.emit("enterCounseling","partner",clientID,partnerID,counselingNo,"pc")}),socket.on("reloadMessage",function(){$.each($(".p_p").toArray(),function(){var e=$(this).text(),t=e.toString().split("/");$(this).text(t[0]+" / 읽음")})}),socket.on("loadMessage",function(e){e.reverse();var t=Number(e.length-1);$.each(e,function(s,n){var i=n.log;i=n.log.replace(/(\r\n|\n\r|\r|\n)/g,"<br/>"),i=retImoji(i),"client"===n.log_from?counselingEl.prepend("<tr class='"+n.no+"'><td class='chat_log_c'><img src='/assets/img/texttime_icon.png' class='c_profile_img'/><span class='c_profile_name'>"+clientName+"</span><table class='chat_log_c_'><tr><td style='padding:16px 12px;'> "+i+" </td></tr></table><p class='c_p'>"+n.time_message+"</p></td></tr>"):"partner"===n.log_from?(0!==e[t].historyClient&&n.no>e[t].historyClient?n.time_message=n.time_message+" / 안 읽음":n.time_message=n.time_message+" / 읽음",counselingEl.prepend("<tr class='"+n.no+"'><td class='chat_log_p'><table class='chat_log_p_'><tr><td style='padding:16px 12px;'> "+i+" </td></tr></table><div id='p_circle'></div><p class='p_p'>"+n.time_message+"</p></td></tr>")):"trost"===n.log_from&&counselingEl.prepend("<tr class='"+n.no+"'><td class='chat_log_tc'><table class='chat_log_tc_'><tr><td>"+i+"</td></tr></table></td></tr>"),loadLastMsgNo=n.no,scrollMsgLoad||ChangeDivScroll()}),$(".loader").css("display","none"),$(".opacityBg").css("display","none")}),socket.on("loadNewMessage",function(e){var t=e.message;t=e.message.replace(/(\r\n|\n\r|\r|\n)/g,"<br/>"),t=retImoji(t),"client"===e.senderStatus?$("#counseling_chat_").append("<tr><td class='chat_log_c'><img src='/assets/img/texttime_icon.png' class='c_profile_img'/><span class='c_profile_name'>"+clientName+"</span><table class='chat_log_c_'><tr><td style='padding:16px 12px;'> "+t+" </td></tr></table><p class='c_p'>"+e.time_message+"</p></td></tr>"):"partner"===e.senderStatus?(e.time_message=e.time_message+" / 안 읽음",$("#counseling_chat_").append("<tr><td class='chat_log_p'><table class='chat_log_p_'><tr><td style='padding:16px 12px;'> "+t+" </td></tr></table><div id='p_circle'></div><p class='p_p'>"+e.time_message+"</p></td></tr>")):"trost"===e.senderStatus&&$("#counseling_chat_").append("<tr><td class='chat_log_tc'><table class='chat_log_tc_'><tr><td>"+t+"</td></tr></table></td></tr>"),ChangeDivScroll()}),socket.on("messageTyping",function(){$("#typingID").length<1&&($("#counseling_chat_").append("<tr id='typingID'><td class='chat_log_c'><img src='/assets/img/texttime_icon.png' class='c_profile_img'/><span class='c_profile_name'>"+clientName+"</span><table class='chat_log_c_'><tr><td style='padding:16px 12px;'> 작성 중 <img src='/assets/img/of_texttime/write_loading.gif' style='vertical-align:middle;margin-left:5px;width:33px;'/> </td></tr></table><p class='c_p'></p></td></tr>"),ChangeDivScroll(),$.each($(".p_p").toArray(),function(){var e=$(this).text(),t=e.toString().split("/");$(this).text(t[0]+" / 읽음")}))}),socket.on("messageStopTyping",function(){$("#typingID").remove()}),$("#send").click(function(){var e=$("#messageSendBox").html();return""==e?(alert("상담 메세지를 입력해주세요."),!1):(e=e.split('<img src="/assets/img/of_emotion/emotion1.png" style="height:20px;vertical-align:bottom;">').join("[감동]"),e=e.split('<img src="/assets/img/of_emotion/emotion2.png" style="height:20px;vertical-align:bottom;">').join("[화남]"),e=e.split('<img src="/assets/img/of_emotion/emotion4.png" style="height:20px;vertical-align:bottom;">').join("[공포]"),e=e.split('<img src="/assets/img/of_emotion/emotion3.png" style="height:20px;vertical-align:bottom;">').join("[고마움]"),e=e.split('<img src="/assets/img/of_emotion/emotion5.png" style="height:20px;vertical-align:bottom;">').join("[궁금]"),e=e.split('<img src="/assets/img/of_emotion/emotion6.png" style="height:20px;vertical-align:bottom;">').join("[기쁨]"),e=e.split('<img src="/assets/img/of_emotion/emotion7.png" style="height:20px;vertical-align:bottom;">').join("[놀람]"),e=e.split('<img src="/assets/img/of_emotion/emotion8.png" style="height:20px;vertical-align:bottom;">').join("[슬픔]"),e=e.split('<img src="/assets/img/of_emotion/emotion9.png" style="height:20px;vertical-align:bottom;">').join("[사랑]"),e=e.split('<img src="/assets/img/of_emotion/emotion10.png" style="height:20px;vertical-align:bottom;">').join("[눈물]"),e=e.split('<img src="/assets/img/of_emotion/emotion11.png" style="height:20px;vertical-align:bottom;">').join("[안녕]"),e=e.split('<img src="/assets/img/of_emotion/emotion12.png" style="height:20px;vertical-align:bottom;">').join("[잘자]"),e=e.split('<img src="/assets/img/of_emotion/emotion13.png" style="height:20px;vertical-align:bottom;">').join("[최고]"),e=e.split('<img src="/assets/img/of_emotion/emotion14.png" style="height:20px;vertical-align:bottom;">').join("[쿨쿨]"),$("#messageSendBox").html(""),$("#messageSendBox").css("height","65px"),emotion_tab_hide(),e=strip_tags(e,"<br/><br>&nbsp;"),e=e.replace(/&gt;/gi,">"),e=e.replace(/&lt;/gi,"<"),e=e.replace(/<br>/gi,"\n"),e=e.replace(/&nbsp;/gi," "),socket.emit("sendMessage",counselingNo,e,"partner","pc"),void(1===statusTyping&&(socket.emit("messageStopTyping"),statusTyping=0)))}),$($("#chatLog")).scroll(function(){if(0==msgContent.scrollTop()){if(1===loadLastMsgNo||0===loadLastMsgNo)return!1;socket.emit("loadOldMessage","partner",clientID,partnerID,counselingNo,loadLastMsgNo),scrollMsgLoad=1}}),$("#MoreMessage").click(function(){return 1===loadLastMsgNo||0===loadLastMsgNo?!1:(socket.emit("loadOldMessage","partner",clientID,partnerID,counselingNo,loadLastMsgNo),void(scrollMsgLoad=1))}),$("#messageSendBox").bind("DOMSubtreeModified",function(){var e=String($("#messageSendBox").html());e.length>=5&&(0===statusTyping&&(socket.emit("messageTyping"),statusTyping=1),1===statusTyping&&setTimeout(function(){(e==$("#messageSendBox").html()||$("#messageSendBox").html().length<5)&&0!==statusTyping&&(socket.emit("messageStopTyping"),statusTyping=0)},2e3))}),$(document).ready(function(){function e(e,t,s){function n(e){return 9>=e?"0"+e:e}function i(){g=a-+new Date,1e3>g?(o.innerHTML="00:00",$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"timeout",roomNumber:counselingNo,userType:usertype}),success:function(e){"Y"==e.result?alert(e.msg):alert(e.msg)}})):(m=new Date(g),c=m.getUTCHours(),l=m.getUTCMinutes(),o.innerHTML=(c?c+":"+n(l):l)+":"+n(m.getUTCSeconds()),setTimeout(i,m.getUTCMilliseconds()+500))}var o,a,c,l,g,m;o=document.getElementById(e),a=+new Date+1e3*(60*t+s)+500,i()}"cordpartner01"===partnerID?($("#firstTab").click(function(){$("#firstTab").addClass("clicked"),$("#againTab").removeClass("clicked"),$(".firstC").css("display",""),$(".againC").css("display","none")}),$("#againTab").click(function(){$("#firstTab").removeClass("clicked"),$("#againTab").addClass("clicked"),$(".againC").css("display",""),$(".firstC").css("display","none")}),$("#firstTab").click()):($("#payChat").click(function(){$("#payChat").addClass("clicked"),$("#freeChat").removeClass("clicked"),$("#ingTab").click(),$("#ingTab, #FinishTab").css("display","inline-block"),$("#ingTab_, #FinishTab_").css("display","none"),$(".payC").css("display",""),$(".payC_, .freeC_, .freeC").css("display","none")}),$("#freeChat").click(function(){$("#payChat").removeClass("clicked"),$("#freeChat").addClass("clicked"),$("#ingTab_").click(),$("#ingTab, #FinishTab").css("display","none"),$("#ingTab_, #FinishTab_").css("display","inline-block"),$(".payC, .payC_, .freeC_").css("display","none"),$(".freeC").css("display","")}),$("#ingTab").click(function(){$("#ingTab").addClass("clicked"),$("#FinishTab").removeClass("clicked"),$("#ingTab_").removeClass("clicked"),$("#FinishTab_").removeClass("clicked"),$(".freeC, .freeC_, .payC_").css("display","none"),$(".payC").css("display","")}),$("#FinishTab").click(function(){$("#ingTab").removeClass("clicked"),$("#FinishTab").addClass("clicked"),$("#ingTab_").removeClass("clicked"),$("#FinishTab_").removeClass("clicked"),$(".freeC, .freeC_, .payC").css("display","none"),$(".payC_").css("display","")}),$("#ingTab_").click(function(){$("#ingTab").removeClass("clicked"),$("#FinishTab").removeClass("clicked"),$("#ingTab_").addClass("clicked"),$("#FinishTab_").removeClass("clicked"),$(".freeC_, .payC, .payC_").css("display","none"),$(".freeC").css("display","")}),$("#FinishTab_").click(function(){$("#ingTab").removeClass("clicked"),$("#FinishTab").removeClass("clicked"),$("#ingTab_").removeClass("clicked"),$("#FinishTab_").addClass("clicked"),$(".freeC, .payC, .payC_").css("display","none"),$(".freeC_").css("display","")}),$("#payChat").click(),$("#ingTab").click()),$(".therapyStart").click(function(){var e=$(".therapyCount").val();if("Y"==checkTherapyState)alert("이미 실시간 상담이 진행되고 있습니다.");else if(""===counselingNo||""===e)alert("먼저 상담 시간을 선택해주세요.");else{var t=confirm("선택한 시간만큼 실시간 상담 횟수가 차감됩니다.\n실시간 상담을 시작하시겠습니까?");t&&$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"start",roomNumber:counselingNo,count:e,userType:usertype}),success:function(e){"Y"==e.result?(alert(e.msg),window.location.reload(!0)):alert(e.msg)}})}}),$(".therapyFinish").click(function(){if("Y"===checkTherapyState){var e=confirm("진행 중인 실시간 상담이 종료되며 실시간 상담 횟수가 차감됩니다. 종료하시겠습니까?");e&&(""===counselingNo?(alert("상담 정보 가져오기에 실패했습니다, 다시 시도해주세요."),window.location.reload(!0)):$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"finish",roomNumber:counselingNo,userType:usertype}),success:function(e){"Y"==e.result?(alert(e.msg),window.location.reload(!0)):alert(e.msg)}}))}else alert("시작된 상담이 없습니다.")}),$(".therapyCancel").click(function(){if(""===counselingNo)alert("상담 정보 가져오기에 실패했습니다, 다시 시도해주세요."),window.location.reload(!0);else{var e=confirm("진행 중인 실시간 상담이 취소되며,\n실시간 상담 횟수가 차감되지 않습니다.\n실시간 상담을 취소하시겠습니까?");e&&$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"cancel",roomNumber:counselingNo,userType:usertype}),success:function(e){"Y"==e.result?(alert(e.msg),window.location.reload(!0)):alert(e.msg)}})}}),$(".modifyChange").click(function(){var e=$(".modifyScheduleDate").val(),t=$("#modifySchedule_timeFrom").val()+":"+$("#modifySchedule_timeto").val(),s=$("#modifySchedule_plan").val();""===e||""===$("#modifySchedule_timeFrom").val()||""===$("#modifySchedule_timeto").val()||""===$("#modifySchedule_plan").val()?alert("실시간 상담 예약 시간을 정확히 입력해주세요."):$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"reservation",roomNumber:counselingNo,bookingDate:e,bookingTime:t,count:s,userType:usertype}),success:function(e){if("Y"==e.result){alert(e.msg);var t=$("#modifySchedule_timeFrom option:selected").val();t>12?(t-=12,t="PM "+t):t="AM "+t,window.location.reload(!0)}else alert(e.msg)}})}),"Y"===payment&&$.ajax({url:"/oauth/counseling/texttime/reservation/",type:"POST",cache:!1,timeout:3e4,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({type:"refresh",roomNumber:counselingNo,userType:usertype}),success:function(t){"Y"==t.result&&($(".therapyCancel").css("display","inline-block"),$(".therapyStart").css("display","none"),$("#therayCountSelect").css("display","none"),checkTherapyState="Y",0!==t.timer&&e("therapyTimer",0,t.timer))}}),$("#messageSendBox").bind("paste",function(){var e=$(this);setTimeout(function(){var t=$(e).html();t=strip_tags(t),t=t.replace(/&nbsp;/gi," "),$("#messageSendBox").html(t)},100)})});
